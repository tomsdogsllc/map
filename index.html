<!-- =========================
 Geoapify Isoline Map
 Carrd Single-Embed Version
 ========================= -->

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<style>
  html, body {
    height: 100%;
    margin: 0;
  }

  .geo-app {
    height: 600px;
    display: grid;
    grid-template-columns: 320px 1fr;
    border-radius: 14px;
    overflow: hidden;
    background: #fff;
    border: 1px solid #e5e7eb;
  }

  @media (max-width: 800px) {
    .geo-app {
      grid-template-columns: 1fr;
      grid-template-rows: auto 420px;
      height: auto;
    }
  }

  #geo-sidebar {
    padding: 14px;
    border-right: 1px solid #eee;
    overflow: auto;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    font-size: 14px;
    line-height: 1.45;
    background: #fafafa;
  }

  #geo-sidebar h1 {
    margin: 0 0 10px;
    font-size: 16px;
  }

  #geo-sidebar .meta {
    color: #333;
    font-size: 13px;
    margin-bottom: 10px;
  }

  .geo-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 6px;
    background: #eef3ff;
    border: 1px solid #dbe7ff;
    font-size: 12px;
    margin-right: 6px;
  }

  .geo-legend {
    margin-top: 12px;
  }

  .geo-legend-item {
    display: flex;
    align-items: center;
    margin: 6px 0;
  }

  .geo-swatch {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    border: 1px solid #cbd5e1;
    margin-right: 8px;
  }

  #geo-map {
    height: 100%;
    width: 100%;
  }
</style>

<div class="geo-app">
  <aside id="geo-sidebar">
    <h1>Drive-Time Reach Map</h1>

    <div class="meta">
      <span class="geo-badge">Leaflet</span>
      <span class="geo-badge">Geoapify</span>
      <span class="geo-badge">Isoline API</span>
    </div>

    <div id="geo-summary">Loadingâ€¦</div>
    <div class="geo-legend" id="geo-legend"></div>

    <p style="margin-top:10px;">
      Each colored region shows how far you can drive within the displayed
      time window from the starting location.
    </p>
  </aside>

  <div id="geo-map"></div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
(() => {

  const apiKey = "f82ea38cb77543d59c597faaa263e714";

  const lat = 30.332039;
  const lon = -81.601305;

  const map = L.map("geo-map").setView([lat, lon], 10);

  const isRetina = L.Browser.retina;
  const baseUrl =
    "https://maps.geoapify.com/v1/tile/osm-bright-grey/{z}/{x}/{y}.png?apiKey={apiKey}";
  const retinaUrl =
    "https://maps.geoapify.com/v1/tile/osm-bright-grey/{z}/{x}/{y}@2x.png?apiKey={apiKey}";

  L.tileLayer(isRetina ? retinaUrl : baseUrl, {
    maxZoom: 20,
    apiKey
  }).addTo(map);

  map.createPane("isoline-fill");
  map.getPane("isoline-fill").style.zIndex = 400;

  map.createPane("markers-top");
  map.getPane("markers-top").style.zIndex = 650;

  const originIcon = L.icon({
    iconUrl: `https://api.geoapify.com/v2/icon/?type=circle&color=%23d784c2&strokeColor=%231e3a8a&size=42&icon=car&iconType=awesome&contentSize=24&noWhiteCircle&scaleFactor=2&apiKey=${apiKey}`,
    iconSize: [42, 42],
    iconAnchor: [21, 21],
    popupAnchor: [0, -25]
  });

  L.marker([lat, lon], { icon: originIcon, pane: "markers-top" })
    .addTo(map)
    .bindPopup("Origin");

  const url = `https://api.geoapify.com/v1/isoline?lat=${lat}&lon=${lon}&type=time&mode=drive&range=900,1200,1800,2400,3000&apiKey=${apiKey}`;

  const palette = [
    "#fff3bf",
    "#b2f2bb",
    "#a5d8ff",
    "#d0bfff",
    "#ffc9c9",
    "#ffd8a8"
  ];

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const ranges = [...new Set(
        data.features.map(f => f.properties?.range).filter(r => typeof r === "number")
      )].sort((a, b) => a - b);

      const colorByRange = {};
      ranges.forEach((r, i) => {
        colorByRange[r] = palette[Math.min(i, palette.length - 1)];
      });

      updateSummaryAndLegend(ranges, colorByRange);
      drawIsolines(data, colorByRange);
    });

  const toMinutes = s => Math.round(s / 60);
  const rangeLabel = r => `${toMinutes(r)} min`;

  function updateSummaryAndLegend(ranges, colorByRange) {
    document.getElementById("geo-summary").textContent =
      `Drive time ranges: ${ranges.map(rangeLabel).join(", ")}`;

    const legend = document.getElementById("geo-legend");
    legend.innerHTML = "<strong>Legend</strong>";

    ranges.forEach(r => {
      const row = document.createElement("div");
      row.className = "geo-legend-item";
      row.innerHTML = `
        <span class="geo-swatch" style="background:${colorByRange[r]}"></span>
        ${rangeLabel(r)}
      `;
      legend.appendChild(row);
    });
  }

  function drawIsolines(data, colorByRange) {
    data.features.sort((a, b) => b.properties.range - a.properties.range);

    L.geoJSON(data, {
      pane: "isoline-fill",
      style: feature => ({
        color: "#1e3a8a",
        weight: 1.5,
        opacity: 0.85,
        fillColor: colorByRange[feature.properties.range] || "#74c0fc",
        fillOpacity: 0.35
      }),
      onEachFeature: (feature, layer) => {
        const r = feature.properties?.range;
        if (r) {
          layer.bindPopup(`Reachable within ${rangeLabel(r)}`);
        }

        layer.on("mouseover", () =>
          layer.setStyle({ weight: 2.5, fillOpacity: 0.45 })
        );
        layer.on("mouseout", () =>
          layer.setStyle({ weight: 1.5, fillOpacity: 0.35 })
        );
      }
    }).addTo(map);
  }

})();
</script>
