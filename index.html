<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<style>
  :root{
    --td-cream:#FFF6E5;
    --td-cream-2:#F7F4ED;
    --td-deep:#0f1b12;
    --td-green:#315532;
    --td-sage:#5E7C60;
    --td-accent:#D9772A;

    --td-ink: rgba(15,27,18,0.92);
    --td-border: rgba(49,85,50,0.20);
    --td-shadow: 0 16px 38px rgba(15,27,18,0.18);
    --td-shadow-soft: 0 12px 28px rgba(15,27,18,0.12);

    --td-radius: 18px;
    --td-radius-sm: 14px;
  }

  html, body { height: 100%; margin: 0; background:#fff; }

  /* Footer-friendly container */
  .geo-app{
    height: 520px;
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 12px;
    padding: 12px;
    box-sizing: border-box;

    border-radius: var(--td-radius);
    overflow: hidden;
    border: 1px solid var(--td-border);

    background:
      radial-gradient(1200px 800px at 18% -10%, rgba(94,124,96,0.18), transparent 60%),
      radial-gradient(900px 650px at 92% 0%, rgba(217,119,42,0.10), transparent 65%),
      #fff;
  }

  @media (max-width: 820px){
    .geo-app{
      grid-template-columns: 1fr;
      grid-template-rows: auto 380px;
      height: auto;
      padding: 10px;
    }
  }

  #geo-sidebar{
    padding: 14px;
    border: 1px solid rgba(49,85,50,0.18);
    border-radius: var(--td-radius);
    overflow: auto;

    font-family: "Nunito", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    font-size: 14px;
    line-height: 1.45;

    background: linear-gradient(180deg, rgba(255,246,229,0.82), rgba(94,124,96,0.10));
    box-shadow: var(--td-shadow-soft);
  }

  #geo-sidebar h2{
    margin: 0 0 10px;
    font-size: 15px;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    font-weight: 900;
    color: var(--td-ink);
  }

  .geo-sub{
    color: rgba(15,27,18,0.76);
    font-size: 13px;
    margin-bottom: 12px;
  }

  .geo-panel{
    margin-top: 10px;
    padding: 12px;
    border-radius: 14px;
    border: 1px solid rgba(49,85,50,0.16);
    background: rgba(247,244,237,0.78);
    box-shadow: 0 10px 22px rgba(15,27,18,0.08);
  }

  .geo-panel-title{
    font-weight: 900;
    font-size: 12px;
    letter-spacing: 0.02em;
    margin-bottom: 8px;
    color: rgba(15,27,18,0.90);
    text-transform: uppercase;
  }

  .geo-legend{ margin-top: 12px; }

  .geo-legend-title{
    font-weight: 900;
    letter-spacing: 0.02em;
    margin: 10px 0 10px;
    color: rgba(15,27,18,0.90);
    text-transform: uppercase;
    font-size: 12px;
  }

  .geo-legend-item{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;

    margin: 10px 0;
    padding: 10px 10px;
    border-radius: 14px;

    border: 1px solid rgba(49,85,50,0.16);
    background: rgba(247,244,237,0.78);
    box-shadow: 0 10px 20px rgba(15,27,18,0.08);
  }

  .geo-legend-item .left{
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }

  .geo-legend-item strong{
    color: var(--td-green);
    font-weight: 900;
    white-space: nowrap;
  }

  .geo-swatch{
    width: 16px;
    height: 16px;
    border-radius: 6px;
    border: 1px solid rgba(15,27,18,0.18);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.55);
  }

  .geo-disclaimer{
    margin-top: 10px;
    font-size: 12px;
    color: rgba(15,27,18,0.72);
  }

  #geo-map{
    height: 100%;
    width: 100%;
    border-radius: var(--td-radius);
    border: 1px solid rgba(49,85,50,0.20);
    box-shadow: var(--td-shadow);
    overflow: hidden;
    background: #fff;
  }

  /* Leaflet polish */
  .leaflet-control-zoom,
  .leaflet-control-attribution{
    border-radius: 14px !important;
    overflow: hidden;
  }
  .leaflet-control-zoom a{
    background: rgba(247,244,237,0.92) !important;
    color: rgba(15,27,18,0.88) !important;
    border: 0 !important;
  }
  .leaflet-control-zoom a:hover{
    background: rgba(255,246,229,0.98) !important;
  }
  .leaflet-control-attribution{
    background: rgba(247,244,237,0.82) !important;
    color: rgba(15,27,18,0.70) !important;
    border: 1px solid rgba(49,85,50,0.14) !important;
    box-shadow: 0 10px 20px rgba(15,27,18,0.10);
  }
  .leaflet-popup-content-wrapper{
    border-radius: 16px !important;
    border: 1px solid rgba(49,85,50,0.18);
    background: rgba(255,246,229,0.96) !important;
    color: rgba(15,27,18,0.92);
    box-shadow: 0 18px 34px rgba(15,27,18,0.18);
  }
  .leaflet-popup-tip{
    background: rgba(255,246,229,0.96) !important;
    border: 1px solid rgba(49,85,50,0.14);
  }
</style>

<div class="geo-app">
  <aside id="geo-sidebar">
    <h2>Travel Fee Zones</h2>
    <div class="geo-sub">Based on driving distance from our home base in New London, CT.</div>

    <div class="geo-panel">
      <div class="geo-panel-title">Home Base</div>
      <div id="geo-origin">Toby May Park, New London, CT</div>
    </div>

    <div class="geo-legend" id="geo-legend"></div>

    <div class="geo-disclaimer">
      Note: zone boundaries follow typical driving routes and may vary slightly by exact address. For locations beyond 30 miles, we will confirm a custom quote.
    </div>
  </aside>

  <div id="geo-map"></div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
(() => {
  const apiKey = "f82ea38cb77543d59c597faaa263e714";

  // Toby May Park (Home Base)
  const lat = 41.3274358;
  const lon = -72.1034902;

  const originLabel = "Home Base: Toby May Park (New London, CT)";
  document.getElementById("geo-origin").textContent = "Toby May Park, New London, CT";

  // Travel-fee distance tiers (miles)
  const bandsMiles = [15, 20, 25, 30];
  const milesToMeters = mi => Math.round(mi * 1609.344);
  const rangesMeters = bandsMiles.map(milesToMeters);

  const feeRows = [
    { label: "0–15 miles", fee: "$0" },
    { label: "15–20 miles", fee: "+$5" },
    { label: "20–25 miles", fee: "+$10" },
    { label: "25–30 miles", fee: "+$15" }
  ];

  const map = L.map("geo-map", { scrollWheelZoom: false }).setView([lat, lon], 11);

  const isRetina = L.Browser.retina;
  const baseUrl = "https://maps.geoapify.com/v1/tile/osm-bright-grey/{z}/{x}/{y}.png?apiKey={apiKey}";
  const retinaUrl = "https://maps.geoapify.com/v1/tile/osm-bright-grey/{z}/{x}/{y}@2x.png?apiKey={apiKey}";

  L.tileLayer(isRetina ? retinaUrl : baseUrl, { maxZoom: 20, apiKey }).addTo(map);

  map.createPane("isoline-fill");
  map.getPane("isoline-fill").style.zIndex = 400;
  map.createPane("markers-top");
  map.getPane("markers-top").style.zIndex = 650;

  const originIcon = L.icon({
    iconUrl: `https://api.geoapify.com/v2/icon/?type=circle&color=%23315532&strokeColor=%230f1b12&size=44&icon=home&iconType=awesome&contentSize=24&noWhiteCircle&scaleFactor=2&apiKey=${apiKey}`,
    iconSize: [44, 44],
    iconAnchor: [22, 22],
    popupAnchor: [0, -26]
  });

  L.marker([lat, lon], { icon: originIcon, pane: "markers-top" })
    .addTo(map)
    .bindPopup(originLabel);

  // Distance isolines so zones match travel fee tiers
  const url =
    `https://api.geoapify.com/v1/isoline?lat=${lat}&lon=${lon}` +
    `&type=distance&mode=drive&range=${rangesMeters.join(",")}&apiKey=${apiKey}`;

  // Palette light → dark by increasing distance
  const palette = ["#fff3bf", "#b2f2bb", "#a5d8ff", "#d0bfff", "#ffc9c9", "#ffd8a8"];

  function renderLegend(colorByRangeMeters){
    const legend = document.getElementById("geo-legend");
    legend.innerHTML = `<div class="geo-legend-title">Per-visit travel fee</div>`;

    feeRows.forEach((row, i) => {
      const maxMi = bandsMiles[i];
      const col = colorByRangeMeters[milesToMeters(maxMi)] || "#74c0fc";

      const item = document.createElement("div");
      item.className = "geo-legend-item";
      item.innerHTML = `
        <span class="left">
          <span class="geo-swatch" style="background:${col}"></span>
          <span>${row.label}</span>
        </span>
        <strong>${row.fee}</strong>
      `;
      legend.appendChild(item);
    });

    const extra = document.createElement("div");
    extra.className = "geo-disclaimer";
    extra.style.marginTop = "8px";
    extra.textContent = "30+ miles: custom quote.";
    legend.appendChild(extra);
  }

  function drawIsolines(data, colorByRange) {
    data.features.sort((a, b) => b.properties.range - a.properties.range);

    L.geoJSON(data, {
      pane: "isoline-fill",
      style: feature => ({
        color: "#0f1b12",
        weight: 1.4,
        opacity: 0.78,
        fillColor: colorByRange[feature.properties.range] || "#74c0fc",
        fillOpacity: 0.35
      }),
      onEachFeature: (feature, layer) => {
        const rMeters = feature.properties?.range;

        let tier = "";
        if (rMeters === milesToMeters(15)) tier = "0–15 miles: $0";
        else if (rMeters === milesToMeters(20)) tier = "15–20 miles: +$5";
        else if (rMeters === milesToMeters(25)) tier = "20–25 miles: +$10";
        else if (rMeters === milesToMeters(30)) tier = "25–30 miles: +$15";

        const lines = [
          `<strong>Travel Fee Zone</strong>`,
          tier ? `<strong>${tier}</strong>` : ""
        ].filter(Boolean);

        layer.bindPopup(lines.join("<br>"));

        layer.on("mouseover", () => layer.setStyle({ weight: 2.4, fillOpacity: 0.45 }));
        layer.on("mouseout", () => layer.setStyle({ weight: 1.4, fillOpacity: 0.35 }));
      }
    }).addTo(map);
  }

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const rangesFound = [...new Set(
        data.features
          .map(f => f.properties?.range)
          .filter(r => typeof r === "number")
      )].sort((a, b) => a - b);

      const colorByRange = {};
      rangesFound.forEach((r, i) => {
        colorByRange[r] = palette[Math.min(i, palette.length - 1)];
      });

      renderLegend(colorByRange);
      drawIsolines(data, colorByRange);
    })
    .catch(() => {
      const legend = document.getElementById("geo-legend");
      legend.innerHTML = `<div class="geo-legend-title">Per-visit travel fee</div>
        <div class="geo-disclaimer">Map temporarily unavailable. Please ask and we will confirm your travel fee.</div>`;
    });
})();
</script>
